<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مصرف جنى</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #121212;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
    }
    .container {
      max-width: 480px;
      margin: 40px auto;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px #8a2be2;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background: #8a2be2;
      color: white;
      cursor: pointer;
    }
    h1, h2 {
      color: #8a2be2;
    }
    .hidden { display: none; }
    #logo {
      width: 100px;
      border-radius: 20%;
      box-shadow: 0 0 10px #8a2be2;
    }
    .note { font-size: 0.9rem; color: #bbb; }
  </style>
</head>
<body>
<div class="container">
  <img src="https://i.ibb.co/Z1WwNsQR/image.png" id="logo">
  <h1>مصرف جنى</h1>

  <div id="loginPage">
    <input type="text" id="loginUsername" placeholder="اسم المستخدم">
    <input type="password" id="loginPassword" placeholder="كلمة المرور">
    <button onclick="login()">تسجيل الدخول</button>
    <button onclick="showRegister()">تسجيل جديد</button>
    <p id="loginMsg"></p>
  </div>

  <div id="registerPage" class="hidden">
    <input type="text" id="registerUsername" placeholder="اسم المستخدم">
    <input type="password" id="registerPassword" placeholder="كلمة المرور">
    <button onclick="register()">إنشاء الحساب</button>
    <button onclick="showLogin()">رجوع</button>
    <p id="registerMsg"></p>
  </div>

  <div id="dashboard" class="hidden">
    <h2 id="welcomeMsg"></h2>
    <p>رقم الحساب: <span id="accNumber"></span></p>
    <p>الرصيد: <span id="balance">0</span> ر.س</p>

    <hr>

    <input type="text" id="transferTarget" placeholder="رقم الحساب المحول إليه">
    <input type="number" id="transferAmount" placeholder="المبلغ">
    <button onclick="transfer()">تحويل</button>
    <p id="transferMsg"></p>

    <input type="text" id="billNumber" placeholder="رقم فاتورة">
    <button onclick="payBill()">سداد</button>
    <p id="billMsg"></p>

    <input type="text" id="devCode" placeholder="رمز المطور">
    <button onclick="addDevFunds()">إضافة أموال</button>

    <button onclick="downloadStatement()">تحميل كشف PDF</button>
    <button onclick="logout()">تسجيل خروج</button>
  </div>
</div>

<script>
const STORAGE_KEY = 'janna_db';
let db = { users: [], history: [] };
let currentUser = null;
const DEV_CODE = "A1B1B1B1B1B1B1B1";

function saveDB() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}
function loadDB() {
  const data = localStorage.getItem(STORAGE_KEY);
  if(data) db = JSON.parse(data);
  else saveDB();
}
function saveCurrentUser() {
  localStorage.setItem("janna_current", currentUser.username);
}
function loadCurrentUser() {
  const u = localStorage.getItem("janna_current");
  if (u) currentUser = db.users.find(user => user.username === u);
}
function showLogin() {
  loginPage.style.display = 'block';
  registerPage.style.display = 'none';
  dashboard.classList.add('hidden');
}
function showRegister() {
  loginPage.style.display = 'none';
  registerPage.style.display = 'block';
  dashboard.classList.add('hidden');
}
function showDashboard() {
  loginPage.style.display = 'none';
  registerPage.style.display = 'none';
  dashboard.classList.remove('hidden');
  document.getElementById("welcomeMsg").textContent = `مرحباً ${currentUser.username}`;
  document.getElementById("accNumber").textContent = currentUser.account;
  updateBalance();
}
function updateBalance() {
  document.getElementById("balance").textContent = currentUser.balance.toFixed(2);
}
function login() {
  const u = loginUsername.value.trim();
  const p = loginPassword.value;
  const found = db.users.find(user => user.username === u && user.password === p);
  if(!found) return loginMsg.textContent = "بيانات غير صحيحة.";
  currentUser = found;
  saveCurrentUser();
  showDashboard();
}
function register() {
  const u = registerUsername.value.trim();
  const p = registerPassword.value;
  if(db.users.find(user => user.username === u)) return registerMsg.textContent = "المستخدم موجود مسبقاً.";
  const acc = Math.floor(1000000000 + Math.random()*9000000000).toString();
  const newUser = { username: u, password: p, account: acc, balance: 0 };
  db.users.push(newUser);
  saveDB();
  registerMsg.textContent = "تم إنشاء الحساب بنجاح!";
}
function logout() {
  currentUser = null;
  localStorage.removeItem("janna_current");
  showLogin();
}
function transfer() {
  const targetAcc = transferTarget.value.trim();
  const amount = parseFloat(transferAmount.value);
  if(isNaN(amount) || amount <= 0) return transferMsg.textContent = "أدخل مبلغاً صالحاً.";
  if(targetAcc === currentUser.account) return transferMsg.textContent = "لا يمكن التحويل لنفس الحساب.";
  const target = db.users.find(u => u.account === targetAcc);
  if(!target) return transferMsg.textContent = "رقم الحساب غير موجود.";
  if(currentUser.balance < amount) return transferMsg.textContent = "الرصيد لا يكفي.";

  currentUser.balance -= amount;
  target.balance += amount;
  db.history.push({ user: currentUser.username, type: 'تحويل', to: targetAcc, amount, date: new Date().toISOString() });
  db.history.push({ user: target.username, type: 'وارد', from: currentUser.account, amount, date: new Date().toISOString() });
  saveDB(); updateBalance();
  transferMsg.textContent = "تم التحويل بنجاح.";
}
function payBill() {
  const number = billNumber.value.trim();
  if(!number) return billMsg.textContent = "أدخل رقم الفاتورة.";
  const amount = Math.floor(Math.random()*280)+20;
  if(currentUser.balance < amount) return billMsg.textContent = `لا يكفي رصيدك (${amount} ر.س)`;
  currentUser.balance -= amount;
  db.history.push({ user: currentUser.username, type: 'فاتورة', number, amount, date: new Date().toISOString() });
  saveDB(); updateBalance();
  billMsg.textContent = `تم السداد (${amount} ر.س)`;
}
function addDevFunds() {
  if(devCode.value.trim() === DEV_CODE) {
    currentUser.balance += 9999;
    db.history.push({ user: currentUser.username, type: 'مطوّر', amount: 9999, date: new Date().toISOString() });
    saveDB(); updateBalance();
    alert("تم إضافة 9999 ر.س لحسابك");
  } else {
    alert("رمز غير صحيح");
  }
}
function downloadStatement() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`كشف حساب - ${currentUser.username}`, 20, 20);
  const history = db.history.filter(h => h.user === currentUser.username);
  let y = 30;
  history.slice(-20).forEach(op => {
    doc.text(`${op.type} - ${op.amount} ر.س - ${op.date}`, 20, y);
    y += 10;
  });
  doc.save("statement.pdf");
}

loadDB();
loadCurrentUser();
if(currentUser) showDashboard();
</script>
</body>
</html>
