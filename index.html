<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مصرف جنى</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');

  body {
    margin: 0;
    background: #121212;
    color: #ddd;
    font-family: 'Cairo', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
  }
  header {
    text-align: center;
    margin-bottom: 25px;
  }
  header img {
    width: 120px;
    border-radius: 25%;
    box-shadow: 0 0 15px #8a2be2;
    margin-bottom: 10px;
  }
  header h1 {
    margin: 0;
    font-size: 2.8rem;
    color: #8a2be2;
    text-shadow: 0 0 10px #8a2be2;
  }

  /* الحاويات */
  .container {
    background: #1f1f1f;
    box-shadow: 0 0 25px #6e33c9cc;
    border-radius: 15px;
    padding: 20px;
    max-width: 420px;
    width: 100%;
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 6px;
    font-weight: bold;
  }
  input[type=text],
  input[type=password],
  input[type=number] {
    width: 100%;
    padding: 10px;
    margin-bottom: 14px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    background: #2c2c2c;
    color: #eee;
    box-sizing: border-box;
  }
  input::placeholder {
    color: #888;
  }
  button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 12px;
    background: #8a2be2;
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #9f4ef7;
  }
  .link {
    margin-top: 10px;
    text-align: center;
    color: #a88cff;
    cursor: pointer;
    user-select: none;
  }
  .link:hover {
    text-decoration: underline;
  }

  /* رسائل الأخطاء */
  .msg {
    color: #e76f51;
    margin-bottom: 10px;
    min-height: 20px;
    text-align: center;
  }
  .msg.success {
    color: #6fcf97;
  }

  /* لوحة المستخدم */
  #dashboard {
    display: none;
  }
  #dashboard h2 {
    margin-top: 0;
    margin-bottom: 12px;
  }
  .info {
    margin-bottom: 15px;
    font-size: 1.05rem;
    background: #2a2a2a;
    padding: 12px 15px;
    border-radius: 10px;
    user-select: text;
  }

  /* أقسام العمليات */
  .section {
    margin-bottom: 25px;
  }
  .section h3 {
    margin-bottom: 12px;
    color: #bb86fc;
  }

  /* جدول سجل العمليات */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #222;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 10px #6e33c9bb;
  }
  th, td {
    padding: 8px 10px;
    color: #ddd;
    border-bottom: 1px solid #444;
    font-size: 0.9rem;
    text-align: center;
  }
  th {
    background: #3b2a72;
  }
  tbody tr:hover {
    background: #3b2a72aa;
  }

  /* إشعار داخل الصفحة */
  #internal-notify {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #8a2be2;
    padding: 15px 25px;
    color: white;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 0 15px #8a2be2;
    display: none;
    z-index: 9999;
    user-select: none;
  }

  /* متجاوب */
  @media (max-width: 480px) {
    .container {
      max-width: 95%;
    }
  }
  
  /* قسم إضافة الأموال للمطور */
  .dev-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #444;
  }
  .dev-section h3 {
    color: #ff9800;
  }
  
  /* قسم إدارة قاعدة البيانات */
  .db-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #444;
  }
  .db-section h3 {
    color: #4caf50;
  }
</style>

</head>
<body>

<header>
  <img src="https://i.ibb.co/Z1WwNsQR/image.png" alt="لوقو مصرف جنى" />
  <h1>مصرف جنى</h1>
</header>

<div id="internal-notify" role="alert" aria-live="assertive"></div>

<!-- صفحة تسجيل الدخول -->
<div class="container" id="login-page">
  <h2>تسجيل الدخول</h2>
  <div class="msg" id="login-msg"></div>
  <label for="login-username">اسم المستخدم</label>
  <input type="text" id="login-username" placeholder="ادخل اسم المستخدم" autocomplete="username" />
  <label for="login-password">كلمة المرور</label>
  <input type="password" id="login-password" placeholder="ادخل كلمة المرور" autocomplete="current-password" />
  <button id="login-btn">تسجيل الدخول</button>
  <div class="link" id="to-register">إنشاء حساب جديد</div>
</div>

<!-- صفحة تسجيل جديد -->
<div class="container" id="register-page" style="display:none;">
  <h2>إنشاء حساب جديد</h2>
  <div class="msg" id="register-msg"></div>
  <label for="reg-username">اسم المستخدم</label>
  <input type="text" id="reg-username" placeholder="اختر اسم مستخدم" autocomplete="username" />
  <label for="reg-password">كلمة المرور</label>
  <input type="password" id="reg-password" placeholder="اختر كلمة المرور" autocomplete="new-password" />
  <button id="register-btn">إنشاء الحساب</button>
  <div class="link" id="to-login">العودة لتسجيل الدخول</div>
</div>

<!-- لوحة المستخدم -->
<div class="container" id="dashboard">
  <h2>مرحبًا، <span id="user-name"></span>!</h2>
  <div class="info"><strong>رقم الحساب:</strong> <span id="user-account"></span></div>
  <div class="info"><strong>الرصيد الحالي:</strong> <span id="user-balance"></span> ر.س</div>

  <div class="section" id="transfer-section">
    <h3>تحويل الأموال</h3>
    <div class="msg" id="transfer-msg"></div>
    <label for="transfer-account">رقم الحساب المستلم</label>
    <input type="text" id="transfer-account" placeholder="أدخل رقم حساب المستلم" />
    <label for="transfer-amount">المبلغ (ر.س)</label>
    <input type="number" id="transfer-amount" min="1" placeholder="أدخل المبلغ" />
    <button id="transfer-btn">إرسال التحويل</button>
  </div>

  <div class="section" id="bill-section">
    <h3>سداد الفواتير</h3>
    <div class="msg" id="bill-msg"></div>
    <label for="bill-number">رقم الفاتورة</label>
    <input type="text" id="bill-number" placeholder="أدخل رقم الفاتورة" />
    <button id="bill-pay-btn">سداد الفاتورة</button>
  </div>

  <div class="section" id="history-section">
    <h3>سجل العمليات</h3>
    <button id="download-pdf-btn" style="margin-bottom:10px;">تحميل كشف حساب PDF</button>
    <table aria-label="سجل العمليات" id="history-table">
      <thead>
        <tr><th>التاريخ</th><th>نوع العملية</th><th>التفاصيل</th><th>المبلغ (ر.س)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- قسم المطور لإضافة الأموال -->
  <div class="dev-section">
    <h3>إضافة أموال (للمطورين)</h3>
    <div class="msg" id="dev-msg"></div>
    <label for="dev-code">كود المطور</label>
    <input type="password" id="dev-code" placeholder="أدخل كود المطور" />
    <button id="dev-add-money-btn">إضافة 20,000 ر.س</button>
  </div>

  <!-- قسم إدارة قاعدة البيانات -->
  <div class="db-section">
    <h3>إدارة قاعدة البيانات</h3>
    <div class="msg" id="db-msg"></div>
    <button id="export-db-btn">تصدير قاعدة البيانات</button>
    <button id="import-db-btn" style="margin-top:10px;">استيراد قاعدة البيانات</button>
    <input type="file" id="db-file-input" accept=".db,.sqlite,.sqlite3" style="display:none;" />
  </div>

  <button id="logout-btn" style="background:#cc4444; margin-top: 15px;">تسجيل خروج</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script>
(() => {
  'use strict';

  // --- المتغيرات الرئيسية ---
  const DB_NAME = 'janna_bank.db';
  const DEVELOPER_CODE = 'A1B1B1B1B1B1B1B1';
  const DEV_BONUS_AMOUNT = 20000;

  let db;
  let currentUser = null;
  let dbFileHandle = null;
  let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  // إشعار داخلي بدل الإشعارات غير المدعومة
  const internalNotify = document.getElementById('internal-notify');

  // عناصر الصفحات
  const loginPage = document.getElementById('login-page');
  const registerPage = document.getElementById('register-page');
  const dashboard = document.getElementById('dashboard');

  // تسجيل الدخول عناصر
  const loginUsernameInput = document.getElementById('login-username');
  const loginPasswordInput = document.getElementById('login-password');
  const loginBtn = document.getElementById('login-btn');
  const loginMsg = document.getElementById('login-msg');
  const toRegisterLink = document.getElementById('to-register');

  // تسجيل جديد عناصر
  const registerUsernameInput = document.getElementById('reg-username');
  const registerPasswordInput = document.getElementById('reg-password');
  const registerBtn = document.getElementById('register-btn');
  const registerMsg = document.getElementById('register-msg');
  const toLoginLink = document.getElementById('to-login');

  // لوحة المستخدم عناصر
  const userNameSpan = document.getElementById('user-name');
  const userAccountSpan = document.getElementById('user-account');
  const userBalanceSpan = document.getElementById('user-balance');

  const transferAccountInput = document.getElementById('transfer-account');
  const transferAmountInput = document.getElementById('transfer-amount');
  const transferBtn = document.getElementById('transfer-btn');
  const transferMsg = document.getElementById('transfer-msg');

  const billNumberInput = document.getElementById('bill-number');
  const billPayBtn = document.getElementById('bill-pay-btn');
  const billMsg = document.getElementById('bill-msg');

  const logoutBtn = document.getElementById('logout-btn');

  const historyTableBody = document.querySelector('#history-table tbody');

  // قسم المطور
  const devCodeInput = document.getElementById('dev-code');
  const devAddMoneyBtn = document.getElementById('dev-add-money-btn');
  const devMsg = document.getElementById('dev-msg');

  // قسم إدارة قاعدة البيانات
  const exportDbBtn = document.getElementById('export-db-btn');
  const importDbBtn = document.getElementById('import-db-btn');
  const dbFileInput = document.getElementById('db-file-input');
  const dbMsg = document.getElementById('db-msg');

  // توليد رقم حساب عشوائي مؤلف من 10 أرقام (رقم الحساب يجب أن يكون فريد)
  async function generateAccountNumber() {
    let num;
    let exists = true;
    
    while (exists) {
      num = '';
      for (let i = 0; i < 10; i++) {
        num += Math.floor(Math.random() * 10);
      }
      
      const result = await db.exec('SELECT 1 FROM users WHERE accountNumber = ?', [num]);
      exists = result.length > 0;
    }
    
    return num;
  }

  // تهيئة قاعدة البيانات
  async function initDB() {
    try {
      // تحميل SQL.js
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
      });
      
      // محاولة تحميل قاعدة البيانات من localStorage (للسفاري والمتصفحات التي لا تدعم File System API)
      let savedDb = localStorage.getItem(DB_NAME);
      let dbData;
      
      if (savedDb) {
        dbData = new Uint8Array(JSON.parse(savedDb)).buffer;
      } else if (!isSafari && 'showOpenFilePicker' in window) {
        // محاولة تحميل قاعدة البيانات من الملف (للمتصفحات الحديثة)
        try {
          [dbFileHandle] = await window.showOpenFilePicker({
            types: [{
              description: 'قاعدة بيانات SQLite',
              accept: {'application/vnd.sqlite3': ['.db']}
            }],
            multiple: false
          });
          const file = await dbFileHandle.getFile();
          const arrayBuffer = await file.arrayBuffer();
          dbData = new Uint8Array(arrayBuffer).buffer;
        } catch (error) {
          console.log('سيتم إنشاء قاعدة بيانات جديدة');
        }
      }
      
      // إنشاء أو تحميل قاعدة البيانات
      db = new SQL.Database(dbData);
      
      // إنشاء الجداول إذا لم تكن موجودة
      db.exec(`
        CREATE TABLE IF NOT EXISTS users (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          username TEXT UNIQUE NOT NULL,
          password TEXT NOT NULL,
          accountNumber TEXT UNIQUE NOT NULL,
          balance REAL DEFAULT 0
        );
        
        CREATE TABLE IF NOT EXISTS transactions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          username TEXT NOT NULL,
          date TEXT NOT NULL,
          type TEXT NOT NULL,
          details TEXT NOT NULL,
          amount REAL NOT NULL
        );
      `);
      
      // حفظ قاعدة البيانات
      await saveDB();
      
      console.log('تم تهيئة قاعدة البيانات بنجاح');
      return true;
    } catch (error) {
      console.error('خطأ في تهيئة قاعدة البيانات:', error);
      showInternalNotify('خطأ في تحميل قاعدة البيانات');
      return false;
    }
  }

  // حفظ قاعدة البيانات
  async function saveDB() {
    if (!db) return;
    
    const dbData = db.export();
    
    if (!isSafari && dbFileHandle) {
      // حفظ في ملف (للمتصفحات الحديثة)
      try {
        const writable = await dbFileHandle.createWritable();
        await writable.write(dbData);
        await writable.close();
        console.log('تم حفظ قاعدة البيانات في الملف');
      } catch (error) {
        console.error('خطأ في حفظ قاعدة البيانات في الملف:', error);
        // في حالة الخطأ، نلجأ لحفظ في localStorage
        localStorage.setItem(DB_NAME, JSON.stringify(Array.from(dbData)));
      }
    } else {
      // حفظ في localStorage (للسفاري والمتصفحات القديمة)
      localStorage.setItem(DB_NAME, JSON.stringify(Array.from(dbData)));
      console.log('تم حفظ قاعدة البيانات في localStorage');
    }
  }

  // تصدير قاعدة البيانات كملف
  async function exportDB() {
    if (!db) return;
    
    try {
      const dbData = db.export();
      const blob = new Blob([dbData], { type: 'application/vnd.sqlite3' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = DB_NAME;
      a.click();
      
      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 100);
      
      dbMsg.classList.add('success');
      dbMsg.textContent = 'تم تصدير قاعدة البيانات بنجاح';
      setTimeout(() => { dbMsg.textContent = ''; dbMsg.classList.remove('success'); }, 3000);
    } catch (error) {
      console.error('خطأ في تصدير قاعدة البيانات:', error);
      dbMsg.textContent = 'حدث خطأ أثناء تصدير قاعدة البيانات';
    }
  }

  // استيراد قاعدة البيانات من ملف
  async function importDB(file) {
    try {
      const arrayBuffer = await file.arrayBuffer();
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
      });
      
      // إنشاء قاعدة بيانات جديدة من الملف المستورد
      const newDb = new SQL.Database(new Uint8Array(arrayBuffer));
      
      // التحقق من أن الملف يحتوي على الجداول المطلوبة
      try {
        newDb.exec('SELECT 1 FROM users LIMIT 1');
        newDb.exec('SELECT 1 FROM transactions LIMIT 1');
      } catch (e) {
        throw new Error('ملف قاعدة البيانات غير صالح');
      }
      
      // استبدال قاعدة البيانات الحالية
      db = newDb;
      
      // حفظ قاعدة البيانات الجديدة
      await saveDB();
      
      // إعادة تحميل الصفحة لتطبيق التغييرات
      location.reload();
    } catch (error) {
      console.error('خطأ في استيراد قاعدة البيانات:', error);
      dbMsg.textContent = 'ملف قاعدة البيانات غير صالح أو تالف';
    }
  }

  // جلب مستخدم حسب اسم المستخدم (غير حساس لحالة الأحرف)
  async function getUserByUsername(username) {
    try {
      const result = await db.exec('SELECT * FROM users WHERE LOWER(username) = LOWER(?)', [username]);
      return result.length ? result[0].values[0] : null;
    } catch (error) {
      console.error('خطأ في جلب المستخدم:', error);
      return null;
    }
  }

  // جلب مستخدم حسب رقم الحساب
  async function getUserByAccount(accountNumber) {
    try {
      const result = await db.exec('SELECT * FROM users WHERE accountNumber = ?', [accountNumber]);
      return result.length ? result[0].values[0] : null;
    } catch (error) {
      console.error('خطأ في جلب المستخدم:', error);
      return null;
    }
  }

  // عرض إشعار (تحاول إشعارات النظام أولاً، ثم تعرض إشعار داخلي)
  function notify(title, body) {
    if (!("Notification" in window)) {
      showInternalNotify(`${title}: ${body}`);
      return;
    }
    if (Notification.permission === "granted") {
      new Notification(title, { body, icon: 'https://i.ibb.co/Z1WwNsQR/image.png' });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification(title, { body, icon: 'https://i.ibb.co/Z1WwNsQR/image.png' });
        } else {
          showInternalNotify(`${title}: ${body}`);
        }
      });
    } else {
      showInternalNotify(`${title}: ${body}`);
    }
  }

  // إشعار داخل الموقع
  let internalNotifyTimeout = null;
  function showInternalNotify(text) {
    if(internalNotifyTimeout) clearTimeout(internalNotifyTimeout);
    internalNotify.textContent = text;
    internalNotify.style.display = 'block';
    internalNotifyTimeout = setTimeout(() => {
      internalNotify.style.display = 'none';
    }, 4000);
  }

  // تحديث واجهة المستخدم مع بيانات المستخدم الحالي
  async function updateDashboard() {
    if(!currentUser) return;
    
    userNameSpan.textContent = currentUser[1]; // username
    userAccountSpan.textContent = currentUser[3]; // accountNumber
    userBalanceSpan.textContent = currentUser[4].toFixed(2); // balance

    await updateHistoryTable();
  }

  // تحديث جدول سجل العمليات
  async function updateHistoryTable() {
    historyTableBody.innerHTML = '';
    
    try {
      const result = await db.exec(
        'SELECT * FROM transactions WHERE username = ? ORDER BY date DESC',
        [currentUser[1]] // username
      );
      
      if (!result.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.textContent = 'لا توجد عمليات حتى الآن';
        td.style.color = '#aaa';
        tr.appendChild(td);
        historyTableBody.appendChild(tr);
        return;
      }
      
      const transactions = result[0].values;
      
      transactions.forEach(tx => {
        const tr = document.createElement('tr');
        const dateTd = document.createElement('td');
        const typeTd = document.createElement('td');
        const detailsTd = document.createElement('td');
        const amountTd = document.createElement('td');

        const d = new Date(tx[2]); // date
        dateTd.textContent = d.toLocaleString('ar-EG');
        typeTd.textContent = tx[3]; // type
        detailsTd.textContent = tx[4]; // details
        amountTd.textContent = tx[5].toFixed(2); // amount

        tr.appendChild(dateTd);
        tr.appendChild(typeTd);
        tr.appendChild(detailsTd);
        tr.appendChild(amountTd);
        historyTableBody.appendChild(tr);
      });
    } catch (error) {
      console.error('خطأ في جلب سجل العمليات:', error);
    }
  }

  // إنشاء حساب جديد
  registerBtn.addEventListener('click', async () => {
    const username = registerUsernameInput.value.trim();
    const password = registerPasswordInput.value;

    registerMsg.textContent = '';
    if(!username || !password) {
      registerMsg.textContent = 'يرجى إدخال اسم المستخدم وكلمة المرور.';
      return;
    }
    
    const existingUser = await getUserByUsername(username);
    if(existingUser) {
      registerMsg.textContent = 'اسم المستخدم هذا موجود مسبقاً.';
      return;
    }

    const newAccountNumber = await generateAccountNumber();

    try {
      await db.exec(
        'INSERT INTO users (username, password, accountNumber, balance) VALUES (?, ?, ?, 0)',
        [username, password, newAccountNumber]
      );
      
      await saveDB();
      
      registerMsg.classList.add('success');
      registerMsg.textContent = `تم إنشاء الحساب بنجاح! رقم حسابك: ${newAccountNumber}`;
      
      // تنظيف الحقول
      registerUsernameInput.value = '';
      registerPasswordInput.value = '';

      setTimeout(() => {
        showLogin();
        registerMsg.textContent = '';
        registerMsg.classList.remove('success');
      }, 2500);
    } catch (error) {
      console.error('خطأ في إنشاء الحساب:', error);
      registerMsg.textContent = 'حدث خطأ أثناء إنشاء الحساب.';
    }
  });

  // تسجيل الدخول
  loginBtn.addEventListener('click', async () => {
    const username = loginUsernameInput.value.trim();
    const password = loginPasswordInput.value;

    loginMsg.textContent = '';
    const user = await getUserByUsername(username);
    
    if(!user || user[2] !== password) { // password
      loginMsg.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
      return;
    }

    currentUser = user;
    loginUsernameInput.value = '';
    loginPasswordInput.value = '';

    showDashboard();
    notify("مصرف جنى", `مرحبًا ${currentUser[1]}، تم تسجيل الدخول بنجاح.`);
  });

  // عرض صفحة تسجيل الدخول
  function showLogin() {
    loginPage.style.display = 'block';
    registerPage.style.display = 'none';
    dashboard.style.display = 'none';
    loginMsg.textContent = '';
    registerMsg.textContent = '';
  }
  
  // عرض صفحة التسجيل
  function showRegister() {
    loginPage.style.display = 'none';
    registerPage.style.display = 'block';
    dashboard.style.display = 'none';
    loginMsg.textContent = '';
    registerMsg.textContent = '';
  }
  
  // عرض لوحة المستخدم
  function showDashboard() {
    loginPage.style.display = 'none';
    registerPage.style.display = 'none';
    dashboard.style.display = 'block';
    transferMsg.textContent = '';
    billMsg.textContent = '';
    devMsg.textContent = '';
    dbMsg.textContent = '';
    updateDashboard();
  }

  toRegisterLink.addEventListener('click', showRegister);
  toLoginLink.addEventListener('click', showLogin);

  // تسجيل خروج
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    showLogin();
    notify("مصرف جنى", "تم تسجيل الخروج.");
  });

  // تحويل الأموال
  transferBtn.addEventListener('click', async () => {
    transferMsg.textContent = '';
    const targetAccount = transferAccountInput.value.trim();
    const amount = parseFloat(transferAmountInput.value);

    if(!targetAccount || isNaN(amount) || amount <= 0) {
      transferMsg.textContent = 'يرجى إدخال رقم حساب صالح ومبلغ أكبر من صفر.';
      return;
    }
    
    if(targetAccount === currentUser[3]) { // accountNumber
      transferMsg.textContent = 'لا يمكنك تحويل الأموال إلى حسابك.';
      return;
    }
    
    const targetUser = await getUserByAccount(targetAccount);
    if(!targetUser) {
      transferMsg.textContent = 'رقم الحساب غير موجود.';
      return;
    }
    
    if(currentUser[4] < amount) { // balance
      transferMsg.textContent = 'رصيدك غير كافٍ لإتمام التحويل.';
      return;
    }

    try {
      // تنفيذ التحويل
      await db.exec(
        'UPDATE users SET balance = balance - ? WHERE id = ?',
        [amount, currentUser[0]] // id
      );
      
      await db.exec(
        'UPDATE users SET balance = balance + ? WHERE id = ?',
        [amount, targetUser[0]] // id
      );
      
      // تسجيل العملية في السجل (لكلا الطرفين)
      const now = new Date().toISOString();
      
      await db.exec(
        'INSERT INTO transactions (username, date, type, details, amount) VALUES (?, ?, ?, ?, ?)',
        [currentUser[1], now, 'تحويل أموال', `إلى حساب ${targetAccount}`, -amount]
      );
      
      await db.exec(
        'INSERT INTO transactions (username, date, type, details, amount) VALUES (?, ?, ?, ?, ?)',
        [targetUser[1], now, 'استلام تحويل', `من حساب ${currentUser[3]}`, amount]
      );
      
      await saveDB();
      
      // تحديث بيانات المستخدم الحالي
      currentUser = (await db.exec('SELECT * FROM users WHERE id = ?', [currentUser[0]]))[0].values[0];
      
      updateDashboard();
      notify("تحويل ناجح", `تم تحويل ${amount.toFixed(2)} ر.س إلى الحساب ${targetAccount}.`);

      transferAccountInput.value = '';
      transferAmountInput.value = '';
    } catch (error) {
      console.error('خطأ في التحويل:', error);
      transferMsg.textContent = 'حدث خطأ أثناء التحويل.';
    }
  });

  // دفع الفواتير
  billPayBtn.addEventListener('click', async () => {
    billMsg.textContent = '';
    const billNumber = billNumberInput.value.trim();
    
    if(!billNumber) {
      billMsg.textContent = 'يرجى إدخال رقم الفاتورة.';
      return;
    }
    
    // الفاتورة عشوائية المبلغ بين 20 و 300 ريال
    const billAmount = Math.floor(Math.random() * 280) + 20;

    if(currentUser[4] < billAmount) { // balance
      billMsg.textContent = `رصيدك غير كافٍ لسداد فاتورة بقيمة ${billAmount} ر.س.`;
      return;
    }

    try {
      // خصم المبلغ
      await db.exec(
        'UPDATE users SET balance = balance - ? WHERE id = ?',
        [billAmount, currentUser[0]] // id
      );
      
      // تسجيل العملية
      const now = new Date().toISOString();
      
      await db.exec(
        'INSERT INTO transactions (username, date, type, details, amount) VALUES (?, ?, ?, ?, ?)',
        [currentUser[1], now, 'سداد فاتورة', `فاتورة رقم ${billNumber}`, -billAmount]
      );
      
      await saveDB();
      
      // تحديث بيانات المستخدم الحالي
      currentUser = (await db.exec('SELECT * FROM users WHERE id = ?', [currentUser[0]]))[0].values[0];
      
      updateDashboard();
      notify("سداد فاتورة", `تم سداد فاتورة رقم ${billNumber} بمبلغ ${billAmount} ر.س.`);

      billNumberInput.value = '';
    } catch (error) {
      console.error('خطأ في سداد الفاتورة:', error);
      billMsg.textContent = 'حدث خطأ أثناء سداد الفاتورة.';
    }
  });

  // إضافة أموال للمطور
  devAddMoneyBtn.addEventListener('click', async () => {
    devMsg.textContent = '';
    const code = devCodeInput.value.trim();
    
    if(code !== DEVELOPER_CODE) {
      devMsg.textContent = 'كود المطور غير صحيح.';
      return;
    }
    
    try {
      // إضافة المبلغ
      await db.exec(
        'UPDATE users SET balance = balance + ? WHERE id = ?',
        [DEV_BONUS_AMOUNT, currentUser[0]] // id
      );
      
      // تسجيل العملية
      const now = new Date().toISOString();
      
      await db.exec(
        'INSERT INTO transactions (username, date, type, details, amount) VALUES (?, ?, ?, ?, ?)',
        [currentUser[1], now, 'إضافة أموال', 'إضافة أموال بواسطة كود المطور', DEV_BONUS_AMOUNT]
      );
      
      await saveDB();
      
      // تحديث بيانات المستخدم الحالي
      currentUser = (await db.exec('SELECT * FROM users WHERE id = ?', [currentUser[0]]))[0].values[0];
      
      updateDashboard();
      notify("إضافة أموال", `تم إضافة ${DEV_BONUS_AMOUNT.toLocaleString()} ر.س إلى حسابك بنجاح.`);
      
      devCodeInput.value = '';
      devMsg.classList.add('success');
      devMsg.textContent = 'تمت إضافة الأموال بنجاح!';
      
      setTimeout(() => {
        devMsg.textContent = '';
        devMsg.classList.remove('success');
      }, 3000);
    } catch (error) {
      console.error('خطأ في إضافة الأموال:', error);
      devMsg.textContent = 'حدث خطأ أثناء إضافة الأموال.';
    }
  });

  // تصدير قاعدة البيانات
  exportDbBtn.addEventListener('click', exportDB);

  // استيراد قاعدة البيانات
  importDbBtn.addEventListener('click', () => {
    dbFileInput.click();
  });

  dbFileInput.addEventListener('change', async (e) => {
    if (e.target.files.length > 0) {
      await importDB(e.target.files[0]);
      e.target.value = ''; // إعادة تعيين حقل الإدخال
    }
  });

  // تحميل كشف حساب PDF باستخدام jsPDF
  document.getElementById('download-pdf-btn').addEventListener('click', async () => {
    if (!currentUser) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4",
      putOnlyUsedFonts:true
    });

    doc.setFont("Cairo", "normal");
    doc.setFontSize(22);
    doc.setTextColor("#8a2be2");
    doc.text("كشف حساب مصرف جنى", 105, 20, null, null, "center");

    doc.setFontSize(14);
    doc.setTextColor("#ddd");
    doc.text(`العميل: ${currentUser[1]}`, 20, 35);
    doc.text(`رقم الحساب: ${currentUser[3]}`, 20, 43);
    doc.text(`الرصيد الحالي: ${currentUser[4].toFixed(2)} ر.س`, 20, 51);

    try {
      // جلب آخر 20 عملية
      const result = await db.exec(
        'SELECT * FROM transactions WHERE username = ? ORDER BY date DESC LIMIT 20',
        [currentUser[1]] // username
      );
      
      const transactions = result.length ? result[0].values : [];

      // إعدادات الجدول
      let startY = 60;
      doc.setFontSize(12);
      doc.setTextColor("#fff");
      doc.text("التاريخ", 20, startY);
      doc.text("نوع العملية", 65, startY);
      doc.text("التفاصيل", 110, startY);
      doc.text("المبلغ (ر.س)", 170, startY);
      startY += 6;

      doc.setDrawColor(138,43,226);
      doc.line(15, startY - 4, 195, startY - 4);

      transactions.forEach(tx => {
        if(startY > 270) {
          doc.addPage();
          startY = 20;
        }
        
        const d = new Date(tx[2]); // date
        doc.setTextColor("#ccc");
        doc.text(d.toLocaleString('ar-EG'), 20, startY);
        doc.text(tx[3], 65, startY); // type
        doc.text(tx[4], 110, startY); // details
        doc.text(tx[5].toFixed(2), 170, startY); // amount
        startY += 8;
      });

      doc.save(`كشف_حساب_${currentUser[1]}.pdf`);
    } catch (error) {
      console.error('خطأ في إنشاء ملف PDF:', error);
      showInternalNotify('حدث خطأ أثناء إنشاء ملف PDF');
    }
  });

  // عند تحميل الصفحة، تهيئة قاعدة البيانات ثم محاولة تسجيل الدخول تلقائياً إذا كان هناك مستخدم محفوظ
  window.addEventListener('load', async () => {
    // تهيئة قاعدة البيانات
    const dbInitialized = await initDB();
    
    if (!dbInitialized) {
      showInternalNotify('تعذر تحميل قاعدة البيانات');
      return;
    }
    
    // جلب آخر مستخدم مسجل دخول (إذا كان هناك طريقة لتخزينه)
    try {
      const result = await db.exec('SELECT * FROM users ORDER BY id DESC LIMIT 1');
      
      if (result.length && result[0].values.length) {
        currentUser = result[0].values[0];
        showDashboard();
      } else {
        showLogin();
      }
    } catch (error) {
      console.error('خطأ في جلب آخر مستخدم:', error);
      showLogin();
    }
  });

  // طلب إذن إشعارات فوري (اختياري)
  if("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
    Notification.requestPermission();
  }

})();
</script>

</body>
</html>